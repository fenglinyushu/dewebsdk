events {
    worker_connections  1024;
}

http {
	upstream dws {
		server 127.0.0.1:8000;
		server 127.0.0.1:8001;
		server 127.0.0.1:8002;
		server 127.0.0.1:8003;
		server 127.0.0.1:8004;
		server 127.0.0.1:8005;
		server 127.0.0.1:8006;
		server 127.0.0.1:8007;
		server 127.0.0.1:8008;
		server 127.0.0.1:8009;
		server 127.0.0.1:8010;
		server 127.0.0.1:8011;
		server 127.0.0.1:8012;
		server 127.0.0.1:8013;
		server 127.0.0.1:8014;
		server 127.0.0.1:8015;
		server 127.0.0.1:8016;
		server 127.0.0.1:8017;
		server 127.0.0.1:8018;
		server 127.0.0.1:8019;

		server 127.0.0.1:8020;
	}
	
	underscores_in_headers on;
 
    server {
        listen       80;
        server_name localhost;

		location / {
			set_by_lua_block $newflag { return ngx.now()*1000 % 10}
			#set $http_shuntflag "A";
			if ($http_shuntflag ~* '^$') {
				set $http_shuntflag $newflag;
			}
			proxy_set_header shuntflag $http_shuntflag; 
			
			echo $http_shuntflag;

			client_max_body_size    1000m;
			
			if ($http_shuntflag ~* (0|5)$) {
				proxy_pass http://127.0.0.1:8080;
				break;
			}
			if ($http_shuntflag ~* (1|6)$) {
				proxy_pass http://127.0.0.1:8081;
				break;
			}
			if ($http_shuntflag ~* (2|7)$) {
				proxy_pass http://127.0.0.1:8082;
				break;
			}
			if ($http_shuntflag ~* (3|8)$) {
				proxy_pass http://127.0.0.1:8083;
				break;
			}
			if ($http_shuntflag ~* (4|9)$) {
				proxy_pass http://127.0.0.1:8084;
				break;
			}
		}
	}
}